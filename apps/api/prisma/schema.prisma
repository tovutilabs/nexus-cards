generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  INCOMPLETE
}

enum CardStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CardPrivacyMode {
  PUBLIC
  PRIVATE
  PASSWORD_PROTECTED
}

enum ShareChannel {
  DIRECT
  WHATSAPP
  TELEGRAM
  SMS
  EMAIL
  LINKEDIN
}

enum NfcTagStatus {
  UNASSOCIATED
  ASSOCIATED
  DEACTIVATED
}

enum IntegrationProvider {
  SALESFORCE
  HUBSPOT
  ZOHO
  MAILCHIMP
  SENDGRID
  ZAPIER
  GOOGLE_DRIVE
  DROPBOX
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum AnalyticsEventType {
  CARD_VIEW
  CONTACT_EXCHANGE
  LINK_CLICK
  QR_SCAN
  NFC_TAP
  SHARE
}

enum ContactSource {
  FORM
  QR
  IMPORTED
  MANUAL
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  passwordHash      String?
  role              UserRole @default(USER)
  emailVerified     Boolean  @default(false)
  emailVerificationToken String?
  passwordResetToken String?
  passwordResetExpires DateTime?
  twoFactorEnabled  Boolean  @default(false)
  twoFactorSecret   String?
  backupCodes       String[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  profile           UserProfile?
  subscription      Subscription?
  cards             Card[]
  contacts          Contact[]
  apiKeys           ApiKey[]
  webhookSubscriptions WebhookSubscription[]
  integrations      Integration[]
  activities        ActivityLog[]
  assignedNfcTags   NfcTag[]        @relation("AssignedNfcTags")
  oauthProviders    OAuthProvider[]
  connectionsAsUserA Connection[]   @relation("ConnectionsAsUserA")
  connectionsAsUserB Connection[]   @relation("ConnectionsAsUserB")
  notifications     Notification[]
  notificationPreferences NotificationPreferences?
  dataExports       UserDataExport[]
  cookieConsents    CookieConsent[]
  cardAccessGranted CardAccessList[] @relation("CardAccessGranted")
  cardAccessGrantedBy CardAccessList[] @relation("CardAccessGrantedBy")

  @@index([email])
  @@map("users")
}

model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  firstName   String?
  lastName    String?
  phone       String?
  company     String?
  jobTitle    String?
  avatarUrl   String?
  timezone    String?
  language    String   @default("en")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Subscription {
  id                String             @id @default(cuid())
  userId            String             @unique
  tier              SubscriptionTier   @default(FREE)
  status            SubscriptionStatus @default(ACTIVE)
  stripeCustomerId  String?            @unique
  stripeSubscriptionId String?         @unique
  stripePriceId     String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean           @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices          Invoice[]

  @@index([userId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

model Invoice {
  id                String   @id @default(cuid())
  subscriptionId    String
  stripeInvoiceId   String?  @unique
  amount            Int
  currency          String   @default("usd")
  status            String
  invoiceUrl        String?
  pdfUrl            String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  subscription      Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("invoices")
}

model Card {
  id              String      @id @default(cuid())
  userId          String
  slug            String      @unique
  status          CardStatus  @default(DRAFT)
  templateId      String?
  firstName       String
  lastName        String
  jobTitle        String?
  company         String?
  email           String?
  phone           String?
  website         String?
  bio             String?
  avatarUrl       String?
  coverImageUrl   String?
  logoUrl         String?
  
  // Privacy and sharing
  privacyMode     CardPrivacyMode @default(PUBLIC)
  defaultPassword String?
  allowContactSubmission Boolean @default(true)
  fieldVisibility Json?           // Per-field privacy controls: { email: 'public', phone: 'private', etc. }
  
  // Theme and styling
  theme           Json?
  customCss       String?
  socialLinks     Json?
  
  // Typography settings
  fontFamily      String?     @default("inter")
  fontSize        String?     @default("base")
  
  // Layout settings
  layout          String?     @default("vertical")
  
  // Background settings
  backgroundType  String?     @default("solid")
  backgroundColor String?     @default("#ffffff")
  backgroundImage String?
  
  // Border and shadow
  borderRadius    String?     @default("md")
  shadowPreset    String?     @default("sm")
  
  // Bilingual support fields
  secondaryLanguage String?   // 'es', 'fr', etc.
  firstName_es      String?
  lastName_es       String?
  jobTitle_es       String?
  company_es        String?
  bio_es            String?
  
  viewCount       Int         @default(0)
  lastViewedAt    DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  template        CardTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  nfcTags         NfcTag[]
  contacts        Contact[]
  analyticsEvents AnalyticsEvent[]
  analyticsDailies AnalyticsCardDaily[]
  shareLinks      ShareLink[]
  accessList      CardAccessList[]

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([templateId])
  @@index([privacyMode])
  @@map("cards")
}

model CardTemplate {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  description     String?
  category        String   // 'tech', 'corporate', 'creative', 'legal', 'healthcare', 'general'
  industry        String[]
  previewImageUrl String?
  
  // Template configuration
  config          Json     // Stores complete template configuration
  
  // Tier restrictions
  minTier         SubscriptionTier @default(FREE)
  
  // Status
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false)
  
  // Metadata
  usageCount      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  cards           Card[]

  @@index([category])
  @@index([slug])
  @@index([minTier])
  @@index([isActive])
  @@map("card_templates")
}

model NfcTag {
  id              String        @id @default(cuid())
  uid             String        @unique
  assignedUserId  String?
  cardId          String?
  status          NfcTagStatus  @default(UNASSOCIATED)
  lastTappedAt    DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  assignedUser    User?         @relation("AssignedNfcTags", fields: [assignedUserId], references: [id], onDelete: SetNull)
  card            Card?         @relation(fields: [cardId], references: [id], onDelete: SetNull)

  @@index([uid])
  @@index([assignedUserId])
  @@index([cardId])
  @@index([status])
  @@map("nfc_tags")
}

model Contact {
  id              String        @id @default(cuid())
  userId          String
  cardId          String
  firstName       String
  lastName        String
  email           String?
  phone           String?
  company         String?
  jobTitle        String?
  notes           String?
  tags            String[]
  category        String?
  favorite        Boolean       @default(false)
  source          ContactSource @default(FORM)
  metadata        Json?
  exchangedAt     DateTime      @default(now())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  card            Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([cardId])
  @@index([email])
  @@index([favorite])
  @@index([category])
  @@map("contacts")
}

model AnalyticsEvent {
  id          String              @id @default(cuid())
  cardId      String
  eventType   AnalyticsEventType
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  referralUrl String?
  country     String?
  region      String?
  city        String?
  deviceType  String?
  deviceModel String?
  os          String?
  browser     String?
  browserVersion String?
  linkUrl     String?
  linkLabel   String?
  scrollDepth Int?
  sessionId   String?
  timestamp   DateTime            @default(now())

  card        Card                @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
  @@index([eventType])
  @@index([timestamp])
  @@index([country])
  @@index([deviceType])
  @@index([browser])
  @@index([sessionId])
  @@map("analytics_events")
}

model AnalyticsCardDaily {
  id               String   @id @default(cuid())
  cardId           String
  date             DateTime @db.Date
  views            Int      @default(0)
  contactExchanges Int      @default(0)
  linkClicks       Int      @default(0)
  qrScans          Int      @default(0)
  nfcTaps          Int      @default(0)
  shares           Int      @default(0)
  uniqueVisitors   Int      @default(0)
  avgScrollDepth   Float?
  topReferrers     Json?
  topCountries     Json?
  deviceBreakdown  Json?
  browserBreakdown Json?
  linkCtr          Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  card             Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([cardId, date])
  @@index([cardId])
  @@index([date])
  @@map("analytics_card_daily")
}

model Integration {
  id          String              @id @default(cuid())
  userId      String
  provider    IntegrationProvider
  status      IntegrationStatus   @default(ACTIVE)
  credentials Json
  settings    Json?
  lastSyncAt  DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([provider])
  @@map("integrations")
}

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  name        String
  keyHash     String   @unique
  keyPrefix   String
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  revokedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
  @@map("api_keys")
}



model ActivityLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  entityType  String?
  entityId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("activity_logs")
}

model SystemSettings {
  id                    String   @id @default(cuid())
  key                   String   @unique
  value                 Json
  description           String?
  category              String?
  updatedBy             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([key])
  @@index([category])
  @@map("system_settings")
}

enum ExperimentStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}

model Experiment {
  id              String            @id @default(cuid())
  name            String
  description     String?
  status          ExperimentStatus  @default(DRAFT)
  startDate       DateTime?
  endDate         DateTime?
  targetPath      String
  variants        Json
  conversionGoal  String
  createdBy       String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  assignments     ExperimentAssignment[]
  events          ExperimentEvent[]

  @@index([status])
  @@index([targetPath])
  @@map("experiments")
}

model ExperimentAssignment {
  id              String      @id @default(cuid())
  experimentId    String
  userId          String?
  sessionId       String
  variant         String
  assignedAt      DateTime    @default(now())

  experiment      Experiment  @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId])
  @@index([sessionId])
  @@map("experiment_assignments")
}

model ExperimentEvent {
  id              String      @id @default(cuid())
  experimentId    String
  sessionId       String
  variant         String
  eventType       String
  eventData       Json?
  timestamp       DateTime    @default(now())

  experiment      Experiment  @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId])
  @@index([sessionId])
  @@index([eventType])
  @@map("experiment_events")
}

enum OAuthProviderType {
  GOOGLE
  LINKEDIN
  MICROSOFT
}

model OAuthProvider {
  id          String            @id @default(cuid())
  userId      String
  provider    OAuthProviderType
  providerId  String
  email       String?
  accessToken String?
  refreshToken String?
  isPrimary   Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider])
  @@map("oauth_providers")
}

enum WebhookEventType {
  CARD_VIEW
  CONTACT_CREATED
  LINK_CLICK
  SUBSCRIPTION_UPDATED
  PAYMENT_SUCCESS
  NFC_TAG_SCAN
  EXPERIMENT_EVENT
}

model WebhookSubscription {
  id              String              @id @default(cuid())
  userId          String
  url             String
  events          WebhookEventType[]
  secret          String
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries      WebhookDelivery[]

  @@index([userId])
  @@index([isActive])
  @@map("webhook_subscriptions")
}

model WebhookDelivery {
  id                    String              @id @default(cuid())
  webhookSubscriptionId String
  eventType             WebhookEventType
  payload               Json
  responseStatus        Int?
  responseBody          String?
  attemptCount          Int                 @default(1)
  deliveredAt           DateTime?
  failedAt              DateTime?
  nextRetryAt           DateTime?
  createdAt             DateTime            @default(now())

  webhookSubscription   WebhookSubscription @relation(fields: [webhookSubscriptionId], references: [id], onDelete: Cascade)

  @@index([webhookSubscriptionId])
  @@index([eventType])
  @@index([deliveredAt])
  @@index([nextRetryAt])
  @@map("webhook_deliveries")
}

model ShareLink {
  id                    String          @id @default(cuid())
  cardId                String
  token                 String          @unique
  name                  String?
  privacyMode           CardPrivacyMode @default(PUBLIC)
  passwordHash          String?
  expiresAt             DateTime?
  maxUses               Int?            // Null = unlimited, positive number = limited uses
  usedCount             Int             @default(0)
  allowContactSubmission Boolean        @default(true)
  channel               ShareChannel    @default(DIRECT)
  shareCount            Int             @default(0)
  lastAccessedAt        DateTime?
  revokedAt             DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  card                  Card            @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
  @@index([token])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("share_links")
}

model CardAccessList {
  id          String   @id @default(cuid())
  cardId      String
  userId      String   // User who is granted access
  grantedBy   String   // Admin or card owner who granted access
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  card        Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user        User     @relation("CardAccessGranted", fields: [userId], references: [id], onDelete: Cascade)
  grantedByUser User   @relation("CardAccessGrantedBy", fields: [grantedBy], references: [id], onDelete: Cascade)

  @@unique([cardId, userId])
  @@index([cardId])
  @@index([userId])
  @@map("card_access_list")
}

model Connection {
  id                    String   @id @default(cuid())
  userAId               String
  userBId               String
  isMutual              Boolean  @default(false)
  firstInteractionDate  DateTime @default(now())
  lastInteractionDate   DateTime @default(now())
  viewCountAtoB         Int      @default(0)
  viewCountBtoA         Int      @default(0)
  strengthScore         Int      @default(0)
  notes                 String?         // Personal notes about this connection
  tags                  String[]        // Tags for categorizing connections: ['client', 'colleague', 'lead']
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  userA                 User     @relation("ConnectionsAsUserA", fields: [userAId], references: [id], onDelete: Cascade)
  userB                 User     @relation("ConnectionsAsUserB", fields: [userBId], references: [id], onDelete: Cascade)

  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
  @@index([isMutual])
  @@index([strengthScore])
  @@map("connections")
}

enum NotificationType {
  NEW_CONTACT
  ANALYTICS_MILESTONE
  PAYMENT_SUCCESS
  NFC_TAG_SCAN
  CARD_VIEW_MILESTONE
  SUBSCRIPTION_EXPIRING
  EXPERIMENT_RESULT
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
}

model Notification {
  id          String            @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  link        String?
  metadata    Json?
  isRead      Boolean           @default(false)
  readAt      DateTime?
  createdAt   DateTime          @default(now())

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreferences {
  id                    String              @id @default(cuid())
  userId                String              @unique
  newContactEmail       Boolean             @default(true)
  newContactInApp       Boolean             @default(true)
  analyticsMilestoneEmail Boolean           @default(true)
  analyticsMilestoneInApp Boolean           @default(true)
  paymentSuccessEmail   Boolean             @default(true)
  paymentSuccessInApp   Boolean             @default(true)
  nfcTagScanEmail       Boolean             @default(false)
  nfcTagScanInApp       Boolean             @default(true)
  cardViewMilestoneEmail Boolean            @default(true)
  cardViewMilestoneInApp Boolean            @default(true)
  subscriptionExpiringEmail Boolean         @default(true)
  subscriptionExpiringInApp Boolean         @default(true)
  marketingEmails       Boolean             @default(false)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model UserDataExport {
  id          String   @id @default(cuid())
  userId      String
  format      String
  status      String
  fileUrl     String?
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("user_data_exports")
}

model CookieConsent {
  id                String   @id @default(cuid())
  userId            String?
  sessionId         String
  necessary         Boolean  @default(true)
  analytics         Boolean  @default(false)
  marketing         Boolean  @default(false)
  preferences       Boolean  @default(false)
  ipAddress         String?
  userAgent         String?
  consentedAt       DateTime @default(now())

  user              User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId])
  @@index([userId])
  @@index([consentedAt])
  @@map("cookie_consents")
}
